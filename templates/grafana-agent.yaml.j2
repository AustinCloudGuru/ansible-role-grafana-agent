server:
    log_level: info

metrics:
  global:
    scrape_interval: 60s
    external_labels:
      environment: development
  wal_directory: /var/lib/grafana-agent/grafana-agent-wal
  configs:
  - name: metrics
    scrape_configs:
      - job_name: external_node_exporter
        static_configs:
          - targets:
            - localhost:9090
        metrics_path: /metrics
        relabel_configs:
            - target_label: instance
              replacement: {{ ansible_hostname }}
    remote_write:
      - url: {{ grafana-agent["prometheus-url"] }}
        basic_auth:
          username: {{ grafana-agent["prometheus-id"] }}
          password: {{ grafana-agent["api-key"] }} 

integrations:
  node_exporter:
    enabled: true
    instance: {{ ansible_hostname }}
  prometheus_remote_write:
    - url: {{ grafana-agent["prometheus-url"] }}
      basic_auth:
        username: {{ grafana-agent["prometheus-id"] }}
        password: {{ grafana-agent["api-key"] }}

logs:
  positions_directory: /var/lib/grafana-agent/log_positions
  configs:
    - name: integrations
      clients:
        - url: {{ grafana-agent["loki-url"] }}
          basic_auth:
            username: {{ grafana-agent["loki-id"] }}
            password: {{ grafana-agent["api-key"] }}
      scrape_configs:
        - job_name: integrations/node_exporter_direct_scrape
          static_configs:
            - targets:
                - localhost
              labels:
                hostname: {{ ansible_hostname }}
                instance: {{ ansible_hostname }}
                job: integrations/node_exporter
                __path__: /var/log/*.log
