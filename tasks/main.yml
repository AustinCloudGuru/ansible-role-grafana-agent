---
- name: Create the Grafana User and Group
  block:
    - name: Create Grafana Group
      ansible.builtin.group:
        name: "{{ grafana_agent_group }}"
        gid: "{{ grafana_agent_gid }}"
        state: present
    - name: Create Grafana User
      ansible.builtin.user:
        name: "{{ grafana_agent_user }}"
        group: "{{ grafana_agent_group }}"
        uid: "{{ grafana_agent_uid }}"
        home: /var/lib/grafana-agent
        state: present

- name: Install Grafana on Debian/Ubuntu
  when: ansible_os_family == "Debian"
  block:
    - name: Add grafana apt repository key.
      ansible.builtin.get_url:
        url: https://apt.grafana.com/gpg.key
        dest: /etc/apt/trusted.gpg.d/grafana.asc
        mode: '0644'
        force: true

    - name: Add grafana Repository
      ansible.builtin.apt_repository:
        repo: deb https://apt.grafana.com stable main
        state: present

- name: Install Grafana on Enterprise Linux
  when: ansible_os_family == "RedHat"
  block:
    - name: Add Grafana Repository
      ansible.builtin.yum_repository:
        name: grafana
        description: Grafana YUM repo
        baseurl: https://rpm.grafana.com
        gpgkey: https://rpm.grafana.com/gpg.key
        gpgcheck: true

- name: Install Grafana Package
  ansible.builtin.package:
    name: grafana-agent
    state: present
  notify: Enable and Start Grafana
                            
